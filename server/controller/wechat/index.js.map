{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../serverTs/controller/wechat/index.ts"],"names":[],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nimport { Request,Response,NextFunction } from 'express';\r\nimport * as HttpRequest from \"request\";\r\nimport { sign,fetch,saveRedis,getRedis } from '../../common/utils';\r\nimport { getAccessToken } from '../common/index';\r\nimport { resolve } from 'path';\r\nimport Auth from '../../common/auth'\r\nconst iconv = require('iconv-lite');\r\nconst sha1 = require('sha1'); \r\nconst config = require('config-lite')(__dirname);\r\nconst auth = new Auth()\r\n\r\nexport default class Wechat {\r\n    getAccessToken() {\r\n        return new Promise((resolve,reject) => {\r\n            fetch({\r\n                method: \"get\",\r\n                url: `${config.wechat.prefix}/token?grant_type=client_credential&appid=${config.wechat.appID}&secret=${config.wechat.appSecret}`,\r\n            }).then((result:any) => {\r\n                var json:any;\r\n                \r\n                json = JSON.parse(result);\r\n                if (!json.access_token || json.errorcode) {\r\n                    reject(json);\r\n                    return;\r\n                }\r\n                json[\"timeStamp\"] = Date.now();\r\n                resolve(json);\r\n            }).catch((error) => {\r\n                reject(error)\r\n                throw new Error(error)\r\n            })\r\n        })\r\n    }\r\n    async sign(req:Request,res:Response) {\r\n        sign(req,res)\r\n    }\r\n    public async getMenu(req:Request,res:Response) {\r\n        const token = await getAccessToken()\r\n        fetch({\r\n            method:'get',\r\n            url:`${config.wechat.prefix}/menu/get?access_token=${token}`\r\n        }).then((result:any) => {\r\n            res.send(result)\r\n            return Promise.resolve(result)\r\n        }).catch((error) => {\r\n            return Promise.reject(error)\r\n        })\r\n    }\r\n    public async createMenu() {\r\n        const token = await getAccessToken()\r\n        return fetch({\r\n            method:'post',\r\n            url:`${config.wechat.prefix}/menu/create?access_token=${token}`,\r\n            json:true,\r\n            body: config.wechatMenu\r\n        }).then((result) => {\r\n            return Promise.resolve(result)\r\n        }).catch((error) => {\r\n            return Promise.reject(error)\r\n        })\r\n    }\r\n    public async requestAuth(req:Request,res:Response) {\r\n        const redirectUrl = auth.requestUrl(config.domain + '/api/wechat/callBack')\r\n        res.redirect(redirectUrl)\r\n    }\r\n    async callBack(req:Request,res:Response,next:NextFunction) {\r\n        function resolveAfter2Seconds(x:any) {\r\n            return new Promise(resolve => {\r\n              setTimeout(() => {\r\n                console.log('1')\r\n                resolve(x);\r\n              }, 4000);\r\n            });\r\n          }\r\n          function resolveAfter2Seconds2(x:any) {\r\n            return new Promise(resolve => {\r\n              setTimeout(() => {\r\n                console.log('2')\r\n                resolve(x);\r\n              }, 1000);\r\n            });\r\n          }\r\n          async function add1(x:any) { \r\n            var a = await resolveAfter2Seconds(20); \r\n            var b = await resolveAfter2Seconds2(30); \r\n          }\r\n          add1(10).then(v => { \r\n            console.log(v); // prints 60 after 4 seconds. \r\n          });\r\n        const wechat = new Wechat()\r\n        console.log(wechat.getAuthPageToken)\r\n        const authPageToken:any = await wechat.getAuthPageToken(req.query.code)\r\n        console.log('authPageToken',authPageToken)\r\n        const updateAuthPageToken:any = await wechat.updateAuthPageToken(authPageToken.refresh_token)\r\n        console.log('updateAuthPageToken',updateAuthPageToken)\r\n        // const userInfo = await wechat.getUser(authPageToken.access_token,authPageToken.openid)\r\n        // console.log('userInfo',userInfo)\r\n        res.send('成功')\r\n    }\r\n    // 获取openId和网页授权token\r\n    getAuthPageToken(code:string) {\r\n        return new Promise((resolve,reject) => {\r\n            fetch({\r\n                url:`${config.wechat.prefixApi}/sns/oauth2/access_token?appid=${config.wechat.appID}&secret=${config.wechat.appSecret}&code=${code}&grant_type=authorization_code`,\r\n                method:'get'\r\n            }).then((result) => {\r\n                resolve(result)\r\n            }).catch((error) => {\r\n                reject(error)\r\n            })\r\n        }) \r\n    }\r\n    // 刷新网页授权token\r\n    updateAuthPageToken(refreshToken:string) {\r\n        console.log('refreshToken',refreshToken)\r\n        return new Promise((resolve,reject) => {\r\n            fetch({\r\n                url:`${config.wechat.prefixApi}/sns/oauth2/refresh_token?appid=${config.wechat.appID}&grant_type=refresh_token&refresh_token=${refreshToken}`,\r\n                method:'get'\r\n            }).then((result) => {\r\n                resolve(result)\r\n            }).catch((error) => {\r\n                reject(error)\r\n            })\r\n        })\r\n    }\r\n    // 获取用户信息\r\n    public async getUser(accessToken:string,openid:string) {\r\n        return fetch({\r\n            url:`${config.wechat.prefixApi}/sns/userinfo?access_token=${accessToken}&openid=${openid}&lang=zh_CN`,\r\n            method:'get'\r\n        }).then((result) => {\r\n            return Promise.resolve(result)\r\n        }).catch((error) => {\r\n            return Promise.reject(error)\r\n        })\r\n    }\r\n}\r\n\r\n/**\r\n * 创建菜单逻辑\r\n */\r\nexport async function startCreateMenu() {\r\n    const result = await new Wechat().createMenu()\r\n}"]}